<?php
/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Version419 extends Doctrine_Migration_Base
{
    public function up()
    {
    	$localidades = localidadTable::getInstance()->createQuery('l')->select('l.id_localidad, l.denominacion')->execute( array(), 'HYDRATE_KEY_VALUE_PAIR' );
    	$idProvincias = localidadTable::getInstance()->createQuery('l')->select('l.id_localidad, l.id_provincia')->execute( array(), 'HYDRATE_KEY_VALUE_PAIR' );
    	
    	
    	$q = Doctrine_Manager::getInstance()->getCurrentConnection();
    	$response = $q->fetchAll("SELECT * FROM carrito_envio;");
    	
    	foreach( $response as $carritoEnvio )
    	{    		
    	    $idLocalidad = $carritoEnvio['id_localidad']; 
    	    $denominacion = $localidades[$idLocalidad];
    	    $idProvincia = $idProvincias[$idLocalidad];
    	        	    
    	    $response = $q->execute("UPDATE carrito_envio SET id_provincia = '$idProvincia', localidad = '$denominacion' WHERE id_carrito_envio = " . $carritoEnvio['id_carrito_envio'] . ";");
    	}
    	
    	
       	$response = $q->fetchAll("SELECT * FROM direccion_envio;");
    	 
    	foreach( $response as $direccionEnvio )
    	{
    	    $idLocalidad = $direccionEnvio['id_localidad']; 
    	    $denominacion = $localidades[$idLocalidad];
    	    $idProvincia = $idProvincias[$idLocalidad];
    			
    		$response = $q->execute("UPDATE direccion_envio SET id_provincia = '$idProvincia', localidad = '$denominacion' WHERE id_direccion_envio = " . $direccionEnvio['id_direccion_envio'] . ";");
    	}
    	
    	$response = $q->fetchAll("SELECT * FROM pedido;");
    	
    	foreach( $response as $pedido )
    	{
    	    $idLocalidad = $pedido['envio_id_localidad']; 
    	    $denominacion = $localidades[$idLocalidad];
    	    $idProvincia = $idProvincias[$idLocalidad];
    		 
    		$response = $q->execute("UPDATE pedido SET envio_id_provincia = '$idProvincia', envio_localidad = '$denominacion' WHERE id_pedido = " . $pedido['id_pedido'] . ";");
    	}
    	
    	$response = $q->fetchAll("SELECT * FROM devolucion;");
    	
    	foreach( $response as $devolucion )
    	{
    		$idLocalidad = isset( $devolucion['id_localidad'] ) ? $devolucion['id_localidad'] : null;
    		if ( $idLocalidad  )
    		{
	    		$denominacion = $localidades[$idLocalidad];
	    		$idProvincia = $idProvincias[$idLocalidad];
	    		 
	    		$response = $q->execute("UPDATE devolucion SET id_provincia = '$idProvincia', localidad = '$denominacion' WHERE id_devolucion = " . $devolucion['id_devolucion'] . ";");
    		}
    		else
    		{
    			$response = $q->execute("UPDATE devolucion SET id_provincia = null, localidad = null WHERE id_devolucion = " . $devolucion['id_devolucion'] . ";");
    		}
    	}
    	
    	$response = $q->fetchAll("SELECT * FROM movimiento_stock_oca;");
    	
    	foreach( $response as $movimientoStockOca )
    	{
    		$idLocalidad = $movimientoStockOca['id_localidad'];
    		$denominacion = $localidades[$idLocalidad];
    		$idProvincia = $idProvincias[$idLocalidad];
    		 
    		$response = $q->execute("UPDATE movimiento_stock_oca SET id_provincia = '$idProvincia', localidad = '$denominacion' WHERE id_movimiento_stock_oca = " . $movimientoStockOca['id_movimiento_stock_oca'] . ";");
    	}
    }

    public function down()
    {
    }
}