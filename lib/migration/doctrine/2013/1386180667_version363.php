<?php
/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Version363 extends Doctrine_Migration_Base
{
    public function up()
    {
        $fechaAyer = date( 'Y-m-d', strtotime('-' . sfConfig::get('app_campana_diasReseteo') . ' days') );
                
        $campanas = campanaTable::getInstance()->createQuery('c')->addWhere('date(c.fecha_fin) < ?', $fechaAyer)->execute();
        
        
        foreach ($campanas as $campana)
        {
            $data = campanaTable::getInstance()->getReporteCampana( $campana->getIdCampana() );
            
            $reporteCampana = new reporteCampana();            
            
            $reporteCampana->setIdCampana( $campana->getIdCampana() );
            $reporteCampana->setRubro( $data['rubro'] );
            $reporteCampana->setCantidadPedidos( $data['total_pedidos'] );
            $reporteCampana->setUnidadesVendidas( $data['unidades_vendidas'] );
            $reporteCampana->setUnidadesPromedioPedido( $data['unidades_promedio_por_pedido'] );
            $reporteCampana->setTotalFacturado( $data['total_facturado'] );
            $reporteCampana->setPdb( $data['precio_deluxe'] );
            $reporteCampana->setCostoTotal( $data['costo'] );
            $reporteCampana->setMargenBruto( $data['margen_bruto'] );
            $reporteCampana->setMargenPromedio( $data['margen_promedio'] );
            $reporteCampana->setTotalStock( $data['total_stock'] );
            
            $ejecucion = '';
                        
            if ( $data['ejecucionXDia'] )
            {
                $ejecucion .= 'Relativa x Dia' . "\n";
                $ejecucion .= '----------------------------' . "\n";
                
                foreach($data['ejecucionXDia'] as $fecha => $porcentaje)
                {
                    $ejecucion .= date('d/m', strtotime($fecha)) . ': ' . $porcentaje . '%' . "\n";
                }
                $ejecucion .= '----------------------------' . "\n";
                $ejecucion .= 'Total Absoluta: ' . $data['ejecucion_stock'] . '%';
            }
            
            
            $reporteCampana->setEjecucionDeStock( $ejecucion );
                        
            $productos = '';
            if ( $data['topProductos'] )
            {
                foreach($data['topProductos'] as $dataProducto)
                {
                    $productos .= $dataProducto['denominacion'] . ' (' . $dataProducto['cantidad'] . ')' . "\n";
                }
            }
            
            $reporteCampana->setTopProductos( $productos );
            
            $reporteCampana->setTicketPromedio( $data['ticket_promedio'] );
            $reporteCampana->setObjetivoFacturacion( $data['objetivo_facturacion'] );
            $reporteCampana->setObjetivoResultado( $data['objetivo_resultado'] );
            $reporteCampana->setCondicionFiscal( $data['condicion_fiscal'] );
            $reporteCampana->setCantidadPedidoHombre( $data['hombres'] );
            $reporteCampana->setCantidadPedidoMujer( $data['mujeres'] );
            $reporteCampana->save();
        }
    }

    public function down()
    {
    
    }
}