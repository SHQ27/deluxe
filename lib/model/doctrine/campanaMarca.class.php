<?php

/**
 * campanaMarca
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    deluxebuys
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class campanaMarca extends BasecampanaMarca
{
    
    /**
     * Retorna un array de dos posiciones con la informacion de cantidad de unidades y pedidos vendidos
     */
    public function getCantidades()
    {
        return pedidoProductoItemTable::getInstance()->getCantidades( $this->getIdCampana(), $this->getIdMarca() );
    }

    public function recibioMercaderia()
    {
        return recepcionMercaderiaCampanaTable::getInstance()->fueRecepcionada( $this->getIdCampana(), $this->getIdMarca() );
    }

    public function vendioStockRefuerzo()
    {
        return campanaTable::getInstance()->vendioStockRefuerzo( $this->getIdCampana(), $this->getIdMarca() );
    }

    public function recepcionFinalizada()
    {
        $campana = $this->getCampana();

        $productos = ordenCompraHelper::getInstance()->makeOrdenCompra(
            $campana->getFechaInicio(),
            $campana->getFechaFin(),
            null,
            $this->getIdMarca(),
            false,
            $campana->getIdCampana()
        );

        $idsProductoItem = array();
        foreach ($productos as $producto) {
            $idsProductoItem[] = $producto['id_producto_item'];
        }

        $recepcion = recepcionMercaderiaCampanaTable::getInstance()->getResumen($campana->getIdCampana(), $idsProductoItem);
        $faltantes = productoItemTable::getInstance()->getCantidadFaltantesByIdCampana($campana->getIdCampana(), $this->getIdMarca());

        foreach ( $productos as $producto ) {
            $idProductoItem =  $producto['id_producto_item'];
            $faltante = isset( $faltantes[ $idProductoItem ] ) ? $faltantes[ $idProductoItem ] : 0;
            $porRecibir = $producto['cantidad'] - ( $recepcion[ $idProductoItem ]['cantidad'] + $faltante );

            if ( $porRecibir > 0  ) {
                return false;
            }
        }

        return true;
    }
    
}
