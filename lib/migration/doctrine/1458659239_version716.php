<?php
/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Version716 extends Doctrine_Migration_Base
{
    public function up()
    {
        $sql  = '';
        $sql .= 'SELECT p.id_pedido, p.envio_tipo, p.envio_nombre, p.envio_apellido, p.envio_calle, p.envio_numero, p.envio_piso, p.envio_depto, p.envio_codigo_postal, p.envio_localidad as dom_localidad, pr.nombre as provincia, l.denominacion as suc_localidad, s.nombre as sucursal, s.calle as suc_calle, s.numero as suc_numero, s.telefono, s.horario_lu_vie, s.horario_sab ';
        $sql .= 'FROM pedido p ';
        $sql .= 'INNER JOIN provincia pr ON pr.id_provincia = p.envio_id_provincia ';
        $sql .= 'LEFT JOIN sucursal_oca s ON s.id_sucursal_oca = p.envio_id_sucursal_oca ';
        $sql .= 'LEFT JOIN localidad l ON l.id_localidad = s.id_localidad ';
        $sql .= 'WHERE envio_detalle IS NULL ';
        $sql .= 'ORDER BY p.id_pedido DESC ';

                        
        $q = Doctrine_Manager::getInstance()->getCurrentConnection();
        $q->execute("UPDATE pedido SET envio_tipo = 'SUC' WHERE envio_tipo = 'OCA';");
        
        $data =  $q->fetchAll( $sql );


        foreach ($data as $row) {


            if ( $row['envio_tipo'] === 'DOM' ) {
                $json = array(
                    'tipo' => $row['envio_tipo'],
                    'destinatario' => trim($row['envio_nombre'] . ' ' . $row['envio_apellido']),
                    'direccion' => trim($row['envio_calle'] . ' ' . $row['envio_numero'] . ' ' . $row['envio_piso']  . ' ' . $row['envio_depto']),
                    'codigo_postal' => $row['envio_codigo_postal'],
                    'provincia' => $row['provincia'],
                    'localidad' => $row['dom_localidad'],
                    'correo' => 'oca',
                    'servicio' => 'N',
                );
            } else {

                $json = array(
                    'tipo' => $row['envio_tipo'],
                    'destinatario' => trim($row['envio_nombre'] . ' ' . $row['envio_apellido']),
                    'sucursal' => $row['sucursal'],
                    'direccion' => trim($row['suc_calle'] . ' ' . $row['suc_numero']),
                    'codigo_postal' => $row['envio_codigo_postal'],
                    'provincia' => $row['provincia'],
                    'localidad' => $row['suc_localidad'],
                    'telefono' => $row['telefono'],
                    'horario' => trim($row['horario_lu_vie']. ' | ' . $row['horario_sab']),
                    'correo' => 'oca',
                    'servicio' => 'N',
                );
            }

            $q->execute("UPDATE pedido SET envio_detalle = ? WHERE id_pedido = " . $row['id_pedido'] . ";", array(json_encode($json)));

        }

    }

    public function down()
    {
    }
}