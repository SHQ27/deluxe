<?php

/**
 * faltante
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    deluxebuys
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class faltante extends Basefaltante
{
    public function getMontoADevolver($detallado = false)
    {
        $pedido = $this->getPedido();
        $productoItem = $this->getProductoItem();
        $pedidoProductoItem = pedidoProductoItemTable::getInstance()->getByCompoundKey($pedido->getIdPedido(), $productoItem->getIdProductoItem() );
        
        $valorProducto = $pedidoProductoItem->getPrecioDeluxe() * $this->getCantidad();
        
        $pedidoDescuento =  $pedido->getPedidoDescuento()->getFirst();
        
        $montoDescuento = 0;
        if ( $pedidoDescuento && $pedidoDescuento->getIdTipoDescuento() != tipoDescuento::FREESHIPPING )
        {
            $montoDescuento = $valorProducto * ($pedido->getMontoDescuento() / $pedido->getMontoProductos() );
        }
        
        $valor = $valorProducto - $montoDescuento;
                
        $esProductoUnico = (pedidoProductoItemTable::getInstance()->countByIdPedido( $pedido->getIdPedido() ) == 1);
        

        if ( $esProductoUnico && $pedidoProductoItem->getCantidad() == $this->getCantidad() )
        {
            $valor += $pedido->getMontoEnvio();
        }

        
        if ( $detallado )
        {                        
            $detalle = array();
            
            $detalle['MP'] = array();
            
            if ( $esProductoUnico && $pedidoProductoItem->getCantidad() == $this->getCantidad() )
            {
                if ( count( $pedido->getPedidoBonificacion() ) )
                {
                    $montoBonificacion = $pedido->getPedidoBonificacion()->getFirst()->getMonto();
                    
                    if ( $pedido->getMontoTotal() == 0 )
                    {
                        $detalle['MP']['EFECTIVO'] = $valor;
                        $detalle['MP']['BONIFICACION'] = 0;                        
                    }
                    else
                    {
                        $detalle['MP']['EFECTIVO'] = $valor - $montoBonificacion;
                        $detalle['MP']['BONIFICACION'] = $montoBonificacion;
                    }
                                        
                }
                else
                {
                    $detalle['MP']['EFECTIVO'] = $valor;
                    $detalle['MP']['BONIFICACION'] = 0;
                }
            }
            else
            {
                $detalle['MP']['EFECTIVO'] = $valor;
                $detalle['MP']['BONIFICACION'] = 0;                
            }
            
            $detalle['BONIFICACION'] = $valor;
            
            return $detalle;
        }
        else
        {
            return $valor;
        }
    }
    
    public function delete(Doctrine_Connection $conn = null)
    {
        if ( !$this->getProcesado() ) {

            $pedido = $this->getPedido();

            if ( $pedido->todosSonFaltantes() ) {
                $pedido->procesarReactivacion(false, false, false, false, false);
            }

            parent::delete( $conn );
        }
    }


    public function getEstadoHTML() {

        if ( $this->getProcesado() ) {

            if ( $this->getIdBonificacion() ) {
                return '<a class="green" href="/backend/bonificaciones/' . $this->getIdBonificacion() . '/edit">Procesado<br/>BonificaciÃ³n #' . $this->getIdBonificacion() . '</a>';
            } else {
                return '<span class="green" >Procesado<br/>Devuelto x MP</span>';
            }

        } else {

            return '<span class="red" >Pendiente</span>';

        }

    }

}
