<?php

/**
 * reporteCampanaTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class reporteCampanaTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object reporteCampanaTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('reporteCampana');
    }
    
    
    /**
     * Reporte de campaÃ±as
     *
     * @param $idsCampana
     *
     * @return Doctrine_Collection
     */
    public function getReporte($idsCampana)
    {
        return $this->createQuery('rc')
                    ->select('rc.*, c.*')
                    ->innerJoin('rc.campana c')
                    ->andWhereIn('rc.id_campana', $idsCampana)
                    ->execute();
    }
    
    /**
     * Guarda toda la informacion de reporte dentro de un objeto aunque sin persistirlo en base de datos
     *
     * @param $data
     *
     * @return reporteCampana
     */
    public function fillObject($idCampana, $data)
    {
	    $reporteCampana = new reporteCampana();	    
	    $reporteCampana->setIdCampana( $idCampana );
	    $reporteCampana->setRubro( $data['rubro'] );
	    $reporteCampana->setCantidadPedidos( $data['total_pedidos'] );
	    $reporteCampana->setUnidadesVendidas( $data['unidades_vendidas'] );
	    $reporteCampana->setUnidadesPromedioPedido( $data['unidades_promedio_por_pedido'] );
	    $reporteCampana->setTotalFacturado( $data['total_facturado'] );
	    $reporteCampana->setPdb( $data['precio_deluxe'] );
	    $reporteCampana->setCostoTotal( $data['costo'] );
	    $reporteCampana->setMargenBruto( $data['margen_bruto'] );
	    $reporteCampana->setMargenPromedio( $data['margen_promedio'] );
	    $reporteCampana->setTotalStock( $data['total_stock'] );
	    
	    $ejecucion = '';
	    if ( $data['ejecucionXDia'] )
	    {
    	    $ejecucion .= 'Relativa x Dia' . "\n";
    	    $ejecucion .= '----------------------------' . "\n";
    	    foreach($data['ejecucionXDia'] as $fecha => $porcentaje)
    	    {
    	        $ejecucion .= date('d/m', strtotime($fecha)) . ': ' . $porcentaje . '%' . "\n";
    	    }
    	    $ejecucion .= '----------------------------' . "\n";
    	    $ejecucion .= 'Total Absoluta: ' . $data['ejecucion_stock'] . '%';
	    }
	    
	    
	    $reporteCampana->setEjecucionDeStock( $ejecucion );
	    
	    $productos = '';
	    if ( $data['topProductos'] )
	    {
    	    foreach($data['topProductos'] as $dataProducto)
    	    {
    	        $productos .= $dataProducto['denominacion'] . ' (' . $dataProducto['cantidad'] . ')' . "\n";
    	    }
	    }
	    
	    $reporteCampana->setTopProductos( $productos );
	    	    
	    $reporteCampana->setTicketPromedio( $data['ticket_promedio'] );
	    $reporteCampana->setObjetivoFacturacion( $data['objetivo_facturacion'] );
	    $reporteCampana->setObjetivoResultado( $data['objetivo_resultado'] );
	    $reporteCampana->setCondicionFiscal( $data['condicion_fiscal'] );
	    $reporteCampana->setCantidadPedidoHombre( $data['hombres'] );
	    $reporteCampana->setCantidadPedidoMujer( $data['mujeres'] );
	    
	    return $reporteCampana;
    }
    
}